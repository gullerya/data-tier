import{Ties}from"./ties.min.js";import{SCOPE_ROOT_KEY,VIEW_PARAMS_KEY,DEFAULT_TIE_TARGET_PROVIDER,getTargetProperty,extractViewParams,CHANGE_EVENT_NAME_PROVIDER,addChangeListener,delChangeListener,getPath,setPath,setViewProperty,callViewFunction}from"./utils.min.js";import{addView,delView}from"./views.min.js";export{DEFAULT_TIE_TARGET_PROVIDER,CHANGE_EVENT_NAME_PROVIDER};export const params=Object.freeze(Array.from(new URL(import.meta.url).searchParams).reduce((e,t)=>(e[t[0]]=t[1],e),{}));export const addRootDocument=e=>{if(!e||Node.DOCUMENT_NODE!==e.nodeType&&Node.DOCUMENT_FRAGMENT_NODE!==e.nodeType)throw new Error("invalid argument, NULL or not one of: DOCUMENT_NODE, DOCUMENT_FRAGMENT_NODE");return roots.has(e)?(console.warn("any root document may be added only once"),!1):(new MutationObserver(processDomChanges).observe(e,MUTATION_OBSERVER_OPTIONS),addTree(e),roots.add(e),!0)};export const removeRootDocument=e=>roots.has(e)?(dropTree(e),roots.delete(e),!0):(console.warn("no root document "+e+" known"),!1);console.info("DT: starting initialization...");const initStartTime=performance.now(),MUTATION_OBSERVER_OPTIONS={childList:!0,subtree:!0,attributes:!0,attributeOldValue:!0,attributeFilter:["data-tie"],characterData:!1,characterDataOldValue:!1},roots=new WeakSet;export const ties=new Ties;function changeListener(e){const t=e.currentTarget,o=getTargetProperty(t),a=t[VIEW_PARAMS_KEY];let n,r,i,s=a.length;for(;s;)(n=a[--s]).targetProperty===o&&(r=ties.get(n.tieKey))&&(i=t[o],setPath(r,n.path,i))}function add(e){if(e.matches(":defined")){e.hasAttribute&&e.hasAttribute("data-tie-scope")&&!e[SCOPE_ROOT_KEY]&&ties.create(e);const t=extractViewParams(e);t&&(addView(e,t),updateFromView(e),addChangeListener(e,changeListener)),e.shadowRoot&&!e.hasAttribute("data-tie-blackbox")&&addRootDocument(e.shadowRoot)}else waitUndefined(e)}function waitUndefined(e){let t="";if(e.localName.indexOf("-")>0)t=e.localName;else{const o=/.*is\s*=\s*"([^"]+)"\s*.*/.exec(e.outerHTML);o&&o.length>1&&(t=o[1])}t?customElements.whenDefined(t).then(()=>add(e)):console.warn("failed to determine tag of yet undefined custom element "+e+", abandoning")}function updateFromView(e){const t=e[VIEW_PARAMS_KEY];let o=t.length;for(;o;){const a=t[--o];if(a.isFunctional){let t=!1;const o=[];a.fParams.forEach(e=>{let a;const n=ties.get(e.tieKey);n&&(a=getPath(n,e.path),t=!0),o.push(a)}),t&&(o.push(null),callViewFunction(e,a.targetProperty,o))}else{const t=ties.get(a.tieKey);if(!t)continue;let o=getPath(t,a.path);void 0===o&&(o=""),setViewProperty(e,a,o)}}}function addTree(e){let t,o=[e];e.childElementCount&&(o=Array.from(e.querySelectorAll("*"))).unshift(e);const a=o.length;for(let e=0;e<a;e++)try{t=o[e],Node.ELEMENT_NODE!==t.nodeType||t[VIEW_PARAMS_KEY]||add(t)}catch(e){console.error("failed to process/add element",e)}}function dropTree(e){let t,o,a,n=[e];for(e.childElementCount&&(n=Array.from(e.querySelectorAll("*"))).unshift(e),t=n.length;t;)(a=(o=n[--t])[VIEW_PARAMS_KEY])&&(delView(o,a),delChangeListener(o,changeListener)),o.shadowRoot&&!o.hasAttribute("data-tie-blackbox")&&removeRootDocument(o.shadowRoot)}function onTieParamChange(e,t,o){let a;t&&(a=e[VIEW_PARAMS_KEY])&&(delView(e,a),delChangeListener(e,changeListener)),o&&(a=extractViewParams(e))&&(addView(e,a),updateFromView(e),addChangeListener(e,changeListener))}function processDomChanges(e){const t=e.length;let o,a,n,r,i,s,d,c,l=0;for(;l<t;l++)if("attributes"===(r=(n=e[l]).type)){const e=n.attributeName,t=n.target,o=n.oldValue,a=t.getAttribute(e);o!==a&&onTieParamChange(t,o,a)}else if("childList"===r){for(s=(i=n.addedNodes).length;s;)a=(o=i[--s]).nodeType,Node.ELEMENT_NODE===a&&addTree(o);for(c=(d=n.removedNodes).length;c;)a=(o=d[--c]).nodeType,Node.ELEMENT_NODE===a&&dropTree(o)}}"false"!==params.autostart&&!1!==params.autostart&&addRootDocument(document),console.info("DT: ... initialization DONE (took "+Math.floor(100*(performance.now()-initStartTime))/100+"ms)");