import{Observable}from"./object-observer.min.js";export const CHANGE_EVENT_NAME_PROVIDER="changeEventName";export const DEFAULT_TIE_TARGET_PROVIDER="defaultTieTarget";export const ties=new Ties;export const addRootDocument=e=>{if(!e||Node.DOCUMENT_NODE!==e.nodeType&&Node.DOCUMENT_FRAGMENT_NODE!==e.nodeType)throw new Error("invalid argument, NULL or not one of: DOCUMENT_NODE, DOCUMENT_FRAGMENT_NODE");if(roots.has(e))return console.warn("any root document may be added only once"),!1;initDocumentObserver(e),console.info("DT: scanning the "+e+" for a views...");const t=performance.now(),n=addTree(e);return console.info("DT: ... scanning the "+e+" for a views DONE (took "+Math.floor(100*(performance.now()-t))/100+"ms, collected "+n+" element/s)"),roots.add(e),!0};export const removeRootDocument=e=>{roots.has(e)?discard(e):console.warn("no root document "+e+" known")};console.info("DT: starting initialization...");const initStartTime=performance.now(),initParams={},PRIVATE_MODEL_SYMBOL=Symbol("private-tie-model-key"),roots=new WeakSet,views={},viewsParams=new WeakMap,PARAM_SPLITTER=/\s*=>\s*/,MULTI_PARAMS_SPLITTER=/\s*[,;]\s*/;Array.from(new URL(import.meta.url).searchParams).forEach(e=>{initParams[e[0]]=e[1]}),Object.keys(initParams).length?(console.info("DT: init params are as following"),console.dir(initParams)):console.info("DT: no init params found");class Tie{constructor(e){this[PRIVATE_MODEL_SYMBOL]=null,Object.defineProperty(this,"name",{value:e}),Object.seal(this)}get model(){return this[PRIVATE_MODEL_SYMBOL]}set model(e){const t=this[PRIVATE_MODEL_SYMBOL];if(e!==t){const n=ensureObservable(e);n&&n.observe(this.processDataChanges.bind(this)),this[PRIVATE_MODEL_SYMBOL]=n,this.processDataChanges([{path:[]}]),t&&t.revoke()}}processDataChanges(e){const t=this.name,n=views[t],o=Object.keys(n),r={};let a,i,s,l,c,d,f,h,m,u,p;if(o.length)for(a=0,i=e.length;a<i;a++){if(l=(s=e[a]).object,c=s.path,!Array.isArray(l)||"insert"!==s.type&&"delete"!==s.type||isNaN(c[c.length-1]))d=c&&c.length?c.join("."):"",p=!1;else{if(r[d=c.slice(0,-1).join(".")]===l)continue;r[d]=l,p=!0}for(f=o.length;f;)if(0===(h=o[--f]).indexOf(d))for(u=(m=n[h]).length;u;)update(m[--u],d,p?null:s)}}}function Ties(){const e={},t=/^[a-zA-Z0-9]+$/;function n(e){if(!e||"string"!=typeof e)throw new Error("tie name MUST be a non empty string");if(!t.test(e))throw new Error("tie name MUST contain alphanumeric characters ONLY (use "+t+' to check yourself); "'+e+'" not fits');return!0}this.get=function(t){return n(t),e[t]},this.create=function(t,o){if(e[t])throw new Error("tie ("+t+") is already present and MAY NOT be re-created");n(t),ensureObservable(o);const r=new Tie(t);return e[t]=r,Object.prototype.hasOwnProperty.call(views,t)||(views[t]={}),r.model=o,r},this.remove=function(t){let o;if("object"==typeof t&&t.name)o=t.name;else{if("string"!=typeof t||!n(t))throw new Error("tie to remove MUST either be a valid tie name or tie self");o=t}delete views[o];const r=e[o];r&&(r[PRIVATE_MODEL_SYMBOL]&&r[PRIVATE_MODEL_SYMBOL].revoke(),delete e[o])},Object.freeze(this)}function ensureObservable(e){if(void 0===e||null===e)return e;if("object"!=typeof e)throw new Error(e+" is not an object");if(Observable.isObservable(e))return e;if(Observable){if(e.observe||e.unobserve||e.revoke)throw new Error(e+" is not of type Observable and can not be transformed into Observable (some of the properties already occupied?)");return Observable.from(e)}throw new Error(e+" is not of type Observable and no embedded Observable implementation found")}function getPath(e,t){if(!e)return null;const n=t.length;let o,r=0;for(;r<n;r++){if(o=t[r],!e||!Object.prototype.hasOwnProperty.call(e,o))return null;e=e[o]}return e}function setPath(e,t,n){if(!e)return;const o=t.length;let r,a=0;for(;a<o-1;a++)e[r=t[a]]&&"object"==typeof e[r]?e=e[r]:(e={})[r]=e;e[t[a]]=n}function changeListener(e){const t=e.currentTarget,n=getDefaultTargetProperty(t),o=viewsParams.get(t);let r,a,i,s;for(i=o.length;i;)(r=o[--i]).targetProperty===n&&((a=ties.get(r.tieName))?(s=t[n],setPath(a[PRIVATE_MODEL_SYMBOL],r.path,s)):console.warn('no Tie identified by "'+r.tieName+'" found'))}function addChangeListenerIfRelevant(e){const t=obtainChangeEventName(e);t&&e.addEventListener(t,changeListener)}function delChangeListener(e){const t=obtainChangeEventName(e);t&&e.removeEventListener(t,changeListener)}function obtainChangeEventName(e){let t=e[CHANGE_EVENT_NAME_PROVIDER];return t||"INPUT"!==e.nodeName&&"SELECT"!==e.nodeName&&"TEXTAREA"!==e.nodeName||(t="change"),t}function add(e){if(e.matches(":defined"))processAddedElement(e);else{let t="";if(e.localName.indexOf("-")>0)t=e.localName;else{const n=/.*is\s*=\s*"([^"]+)"\s*.*/.exec(e.outerHTML);n&&n.length>1&&(t=n[1])}t?customElements.whenDefined(t).then(()=>processAddedElement(e)):(console.warn("failed to determine yet undefined custom element name of "+e+" to wait for definition; processing as usual"),processAddedElement(e))}}function processAddedElement(e){const t=extractTieParams(e);let n,o,r,a,i,s=0;for(i=t.length;s<i;s++)n=t[s].tieName,o=t[s].rawPath,(a=(r=views[n]||(views[n]={}))[o]||(r[o]=[])).indexOf(e)<0&&(a.push(e),viewsParams.set(e,t),update(e),addChangeListenerIfRelevant(e));e.shadowRoot&&addRootDocument(e.shadowRoot)}function extractTieParams(e){let t,n=[];return e&&e.dataset&&(t=e.dataset.tie)&&(n=parseTiePropertiesParam(t,e)),n}function parseTiePropertyParam(e,t){const n=e.split(PARAM_SPLITTER);1===n.length&&n.push(getDefaultTargetProperty(t));const o=n[0].split(":");if(!o.length||o.length>2||!o[0])throw new Error('invalid tie value; found: "'+e+'"; expected (example): "orders:0.address.street => textContent"');const r=o.length>1?o[1]:"";return{tieName:o[0],rawPath:r,path:r.split(".").filter(e=>e),targetProperty:n[1]}}function parseTiePropertiesParam(e,t){if(!e||"string"!=typeof e)throw new Error('invalid tie value; found: "'+e+'"; expected (example): "orders:0.address.street => textContent, orders:0.address.apt => title"');const n=[],o=e.split(MULTI_PARAMS_SPLITTER),r=o.length;let a=0;for(;a<r;a++)if(o[a])try{n.push(parseTiePropertyParam(o[a],t))}catch(e){console.error("failed to parse one of a multi param parts",e)}return n}function getDefaultTargetProperty(e){let t=e[DEFAULT_TIE_TARGET_PROVIDER];if(!t){const n=e.nodeName;t="INPUT"===n&&"checkbox"===e.type?"checked":"INPUT"===n||"SELECT"===n||"TEXTAREA"===n?"value":"IMG"===n||"IFRAME"===n||"SOURCE"===n?"src":"textContent"}return t}function update(e,t,n){const o=viewsParams.get(e);let r,a,i,s,l,c,d=0;for(l=o.length;d<l;d++)r=o[d],t&&0!==r.rawPath.indexOf(t)||(a=ties.get(r.tieName))&&(i=a.model,void 0===(s=n&&t===r.rawPath&&void 0!==n.value?n.value:getPath(i,r.path))&&(s=""),"value"===(c=r.targetProperty)&&"INPUT"===e.nodeName&&"checkbox"===e.type?e.checked=s:"href"===c?e.href.baseVal=s:e[c]=s)}function addTree(e){const t=e.querySelectorAll("*");let n=t.length,o=t.length;for(Node.ELEMENT_NODE===e.nodeType&&(add(e),o++);n;)try{add(t[--n])}catch(e){console.error("failed to process/add element",e)}return o}function discard(e){if(e.querySelectorAll){const t=e.querySelectorAll("*"),n=t.length;let o,r,a,i,s,l,c,d=0;for(;d<=n;d++){if(o=d<n?t[d]:e,r=viewsParams.get(o)){for(l=0,c=r.length;l<c;l++)a=r[l],views[a.tieName]&&(s=(i=views[a.tieName][a.rawPath]).indexOf(o))>=0&&(i.splice(s,1),delChangeListener(o));viewsParams.delete(o)}o.shadowRoot&&removeRootDocument(o.shadowRoot)}}}function move(e,t,n,o){let r,a,i,s,l,c,d;if(n){for(a=0,i=(r=viewsParams.get(e)).length;a<i;a++)s=r[a],views[s.tieName]&&(c=views[s.tieName][s.rawPath])&&(d=c.indexOf(e))>=0&&c.splice(d,1);delChangeListener(e)}if(o){for(r=parseTiePropertiesParam(o,e),viewsParams.set(e,r),a=0,i=r.length;a<i;a++)s=r[a],(c=(l=views[s.tieName]||(views[s.tieName]={}))[s.rawPath]||(l[s.rawPath]=[])).indexOf(e)<0&&(c.push(e),update(e,s.rawPath));addChangeListenerIfRelevant(e)}}function processDomChanges(e){const t=e.length;let n,o,r,a,i,s,l,c,d,f=0;for(;f<t;f++)if("attributes"===(a=(r=e[f]).type))"data-tie"===(i=r.attributeName)&&move(n=r.target,i,r.oldValue,n.getAttribute(i));else if("childList"===a){for(l=(s=r.addedNodes).length;l;)o=(n=s[--l]).nodeType,Node.ELEMENT_NODE===o&&addTree(n);for(d=(c=r.removedNodes).length;d;)o=(n=c[--d]).nodeType,Node.ELEMENT_NODE===o&&discard(n)}}function initDocumentObserver(e){console.info("DT: initializing DOM observer on "+e),new MutationObserver(processDomChanges).observe(e,{childList:!0,subtree:!0,attributes:!0,attributeOldValue:!0,attributeFilter:["data-tie"],characterData:!1,characterDataOldValue:!1})}addRootDocument(document),console.info("DT: ... initialization DONE (took "+Math.floor(100*(performance.now()-initStartTime))/100+"ms)");