import{Observable}from"./object-observer.min.js";export const CHANGE_EVENT_NAME_PROVIDER="changeEventName";export const DEFAULT_TIE_TARGET_PROVIDER="defaultTieTarget";export const ties=new Ties;export const addRootDocument=e=>{if(!e||Node.DOCUMENT_NODE!==e.nodeType&&Node.DOCUMENT_FRAGMENT_NODE!==e.nodeType)throw new Error("invalid argument, NULL or not one of: DOCUMENT_NODE, DOCUMENT_FRAGMENT_NODE");if(roots.has(e))return console.warn("any root document may be added only once"),!1;initDocumentObserver(e),console.debug("DT: scanning the document for a views...");const t=performance.now();return addTree(e),console.debug("DT: ... scanning the "+e+" for a views DONE (took "+Math.floor(100*(performance.now()-t))/100+"ms"),roots.add(e),!0};export const removeRootDocument=e=>roots.has(e)?(discard(e),roots.delete(e),!0):(console.warn("no root document "+e+" known"),!1);console.info("DT: starting initialization...");const initStartTime=performance.now(),ELEMENT_PROCESSED_SYMBOL=Symbol("element-processed"),roots=new WeakSet,views={},viewsParams=new WeakMap,PARAM_SPLITTER=/\s*=>\s*/,MULTI_PARAMS_SPLITTER=/\s*[,;]\s*/;class Tie{constructor(e,t){this.name=e,this.model=t,this.observer=Tie.processDataChanges.bind(this),this.model.observe(this.observer),Object.freeze(this)}static processDataChanges(e){const t=this.name,o=views[t],n=Object.keys(o),r={};let a,s,i,l,c,d,f,h,m,u="";if(n.length)for(a=0,s=e.length;a<s;a++){if(l=(i=e[a]).object,c=i.path,!Array.isArray(l)||"insert"!==i.type&&"delete"!==i.type||isNaN(c[c.length-1])){const e=c.length;if(e>1){for(let t=0;t<e-1;t++)u+=c[t]+".";u+=c[e-1]}else 1===e&&(u=c[0])}else{if(r[u=c.slice(0,-1).join(".")]===l)continue;r[u]=l,i=null}for(d=n.length;d;)if(0===(f=n[--d]).indexOf(u))for(m=(h=o[f]).length;m;)update(h[--m],u,i)}}}function Ties(){const e={},t=/^[a-zA-Z0-9]+$/;this.get=function(t){return e[t]?e[t].model:void 0},this.create=function(o,n){if(e[o])throw new Error('tie "'+o+'" already exists');!function(e){if(!e||"string"!=typeof e)throw new Error("tie name MUST be a non empty string");if(!t.test(e))throw new Error("tie name MUST match "+t+'; "'+e+'" is not')}(o),o in views||(views[o]={});const r=ensureObservable(n);return e[o]=new Tie(o,r),e[o].observer([{path:[]}]),r},this.remove=function(t){let o;if("object"==typeof t)o=Object.keys(e).find(o=>e[o].model===t);else{if("string"!=typeof t)throw new Error("tie to remove MUST either be a valid tie name or tie self");o=t}delete views[o];const n=e[o];n&&(n.model&&n.model.revoke(),delete e[o])},Object.freeze(this)}function ensureObservable(e){let t;return e?Observable.isObservable(e)||(t=Observable.from(e)):t=Observable.from({}),t}function getPath(e,t){if(!e)return null;const o=t.length;let n,r=0;for(;r<o-1;r++)if(null===(e=e[n=t[r]])||void 0===e)return null;return e[t[r]]}function setPath(e,t,o){if(!e)return;const n=t.length;let r,a=0;for(;a<n-1;a++)e[r=t[a]]&&"object"==typeof e[r]||(e[r]={}),e=e[r];e[t[a]]=o}function changeListener(e){const t=e.currentTarget,o=getDefaultTargetProperty(t),n=viewsParams.get(t);let r,a,s,i=n.length;for(;i;)(r=n[--i]).targetProperty===o&&((a=ties.get(r.tieName))?(s=t[o],setPath(a,r.path,s)):console.warn('no Tie found by "'+r.tieName+'"'))}function addChangeListenerIfRelevant(e){const t=obtainChangeEventName(e);t&&e.addEventListener(t,changeListener)}function delChangeListener(e){const t=obtainChangeEventName(e);t&&e.removeEventListener(t,changeListener)}function obtainChangeEventName(e){let t=e[CHANGE_EVENT_NAME_PROVIDER];return t||"INPUT"!==e.nodeName&&"SELECT"!==e.nodeName&&"TEXTAREA"!==e.nodeName||(t="change"),t}function add(e){if(e[ELEMENT_PROCESSED_SYMBOL]=!0,e.matches(":defined"))processAddedElement(e);else{let t="";if(e.localName.indexOf("-")>0)t=e.localName;else{const o=/.*is\s*=\s*"([^"]+)"\s*.*/.exec(e.outerHTML);o&&o.length>1&&(t=o[1])}t?customElements.whenDefined(t).then(()=>processAddedElement(e)):(console.warn("failed to determine yet undefined custom element name of "+e+" to wait for definition; processing as usual"),processAddedElement(e))}}function processAddedElement(e){const t=extractTieParams(e);let o,n,r,a,s=t.length;for(;s;){const i=t[--s];o=i.tieName,n=i.rawPath,(a=(r=views[o]||(views[o]={}))[n]||(r[n]=[])).indexOf(e)<0&&(a.push(e),viewsParams.set(e,t),update(e),addChangeListenerIfRelevant(e))}e.shadowRoot&&addRootDocument(e.shadowRoot)}function extractTieParams(e){let t,o=[];return e&&e.dataset&&(t=e.dataset.tie)&&(o=parseTiePropertiesParam(t,e)),o}function parseTiePropertyParam(e,t){const o=e.split(PARAM_SPLITTER);1===o.length&&o.push(getDefaultTargetProperty(t));const n=o[0].split(":");if(!n.length||n.length>2||!n[0])throw new Error('invalid tie value; found: "'+e+'"; expected (example of multi param, one with default target): "orders:0.address.street, orders:0.address.apt => title"');const r=n.length>1?n[1]:"";return{tieName:n[0],rawPath:r,path:r.split(".").filter(e=>e),targetProperty:o[1]}}function parseTiePropertiesParam(e,t){const o=[],n={},r=e.split(MULTI_PARAMS_SPLITTER),a=r.length;let s,i,l=0;for(;l<a;l++)if(s=r[l])try{(i=parseTiePropertyParam(s,t)).targetProperty in n?console.error("elements's property \""+i.targetProperty+'" tied more than once; all but first ties dismissed'):(o.push(i),n[i.targetProperty]=!0)}catch(e){console.error("failed to parse one of a multi param parts ("+s+"), skipping it",e)}return o}function getDefaultTargetProperty(e){let t=e[DEFAULT_TIE_TARGET_PROVIDER];if(!t){const o=e.nodeName;t="INPUT"===o&&"checkbox"===e.type?"checked":"INPUT"===o||"SELECT"===o||"TEXTAREA"===o?"value":"IMG"===o||"IFRAME"===o||"SOURCE"===o?"src":"textContent"}return t}function update(e,t,o){const n=viewsParams.get(e);let r,a,s,i,l=n.length;for(;l;)r=n[--l],void 0!==(a=ties.get(r.tieName))&&(t&&0!==r.rawPath.indexOf(t)||(void 0===(s=o&&t===r.rawPath&&void 0!==o.value?o.value:getPath(a,r.path))&&(s=""),"value"===(i=r.targetProperty)&&"INPUT"===e.nodeName&&"checkbox"===e.type?e.checked=s:"href"===i?e.href.baseVal=s:e[i]=s))}function addTree(e){let t;e.childElementCount?(t=Array.from(e.querySelectorAll("*"))).unshift(e):t=[e];let o,n=t.length;for(;n;)try{o=t[--n],Node.ELEMENT_NODE!==o.nodeType||o[ELEMENT_PROCESSED_SYMBOL]||add(o)}catch(e){console.error("failed to process/add element",e)}}function discard(e){if(e.querySelectorAll){const t=e.querySelectorAll("*"),o=t.length;let n,r,a,s,i,l,c,d=0;for(;d<=o;d++){if(n=d<o?t[d]:e,r=viewsParams.get(n)){for(l=0,c=r.length;l<c;l++)a=r[l],views[a.tieName]&&(i=(s=views[a.tieName][a.rawPath]).indexOf(n))>=0&&(s.splice(i,1),delChangeListener(n));viewsParams.delete(n)}n.shadowRoot&&removeRootDocument(n.shadowRoot)}}}function move(e,t,o){let n,r,a,s,i,l,c;if(t){for(r=0,a=(n=viewsParams.get(e)).length;r<a;r++)s=n[r],views[s.tieName]&&(l=views[s.tieName][s.rawPath])&&(c=l.indexOf(e))>=0&&l.splice(c,1);delChangeListener(e)}if(o){for(n=parseTiePropertiesParam(o,e),viewsParams.set(e,n),r=0,a=n.length;r<a;r++)s=n[r],(l=(i=views[s.tieName]||(views[s.tieName]={}))[s.rawPath]||(i[s.rawPath]=[])).indexOf(e)<0&&(l.push(e),update(e,s.rawPath));addChangeListenerIfRelevant(e)}}function processDomChanges(e){const t=e.length;let o,n,r,a,s,i,l,c,d,f=0;for(;f<t;f++)if("attributes"===(a=(r=e[f]).type))s=r.attributeName,move(o=r.target,r.oldValue,o.getAttribute(s));else if("childList"===a){for(l=(i=r.addedNodes).length;l;)n=(o=i[--l]).nodeType,Node.ELEMENT_NODE===n&&addTree(o);for(d=(c=r.removedNodes).length;d;)n=(o=c[--d]).nodeType,Node.ELEMENT_NODE===n&&discard(o)}}function initDocumentObserver(e){console.debug("DT: initializing DOM observer on document"),new MutationObserver(processDomChanges).observe(e,{childList:!0,subtree:!0,attributes:!0,attributeOldValue:!0,attributeFilter:["data-tie"],characterData:!1,characterDataOldValue:!1})}addRootDocument(document),console.info("DT: ... initialization DONE (took "+Math.floor(100*(performance.now()-initStartTime))/100+"ms)");