import{Observable}from"./object-observer.js";export const ties=new Ties;const PRIVATE_MODEL_SYMBOL=Symbol("private-tie-model-key"),views={},viewsParams=new WeakMap,PARAM_SPLITTER=/\s*=>\s*/,MULTI_PARAMS_SPLITTER=/\s*[,;]\s*/;class Tie{constructor(e){this[PRIVATE_MODEL_SYMBOL]=null,Object.defineProperty(this,"name",{value:e}),Object.seal(this)}get model(){return this[PRIVATE_MODEL_SYMBOL]}set model(e){let t=this[PRIVATE_MODEL_SYMBOL];if(e!==t){let n=ensureObservable(e);n&&n.observe(this.processDataChanges.bind(this)),this[PRIVATE_MODEL_SYMBOL]=n,this.processDataChanges([{path:[]}]),t&&t.revoke()}}processDataChanges(e){let t,n,r,o,a,i,s,l,d,c,f=this.name,u=this[PRIVATE_MODEL_SYMBOL],m=views[f],h=Object.keys(m),p={};if(h.length)for(t=0,n=e.length;t<n;t++){if(o=(r=e[t]).path,!Array.isArray(r.object)||"insert"!==r.type&&"delete"!==r.type||isNaN(o[o.length-1]))a=o&&o.length?o.join("."):"",c=!1;else{if(p[a=o.slice(0,-1).join(".")]===r.object)continue;p[a]=r.object,c=!0}for(i=h.length;i--;)if(0===(s=h[i]).indexOf(a))for(d=(l=m[s]).length;d--;)update(l[d],u,a,c?null:r)}}}function Ties(){const e={},t=/^[a-zA-Z0-9]+$/;function n(e){if(!e||"string"!=typeof e)throw new Error("tie name MUST be a non empty string");if(!t.test(e))throw new Error("tie name MUST contain alphanumeric characters ONLY (use "+t+' to check yourself); "'+e+'" not fits')}this.get=function(t){return n(t),e[t]},this.create=function(t,r){if(n(t),e[t])throw new Error("tie ("+t+") is already present and MAY NOT be re-created");let o=new Tie(t);return e[t]=o,views.hasOwnProperty(t)||(views[t]={}),o.model=r,o},this.remove=function(t){n(t),delete views[t];let r=e[t];r&&(r[PRIVATE_MODEL_SYMBOL]&&r[PRIVATE_MODEL_SYMBOL].revoke(),delete e[t])},Object.freeze(this)}function ensureObservable(e){if(void 0===e||null===e)return e;if("object"!=typeof e)throw new Error(e+" is not of type Observable and not an object");if(Observable.isObservable(e))return e;if(Observable){if("function"==typeof e.observe||"function"==typeof e.unobserve||"function"==typeof e.revoke)throw new Error(e+" is not of type Observable and can not be transformed into Observable (some of its functions already implemented?)");return Observable.from(e)}throw new Error(e+" is not of type Observable and no embedded Observable implementation found")}function getPath(e,t){if(!e)return;let n,r=0,o=t.length;for(;r<o;r++){if(n=t[r],!e||!e.hasOwnProperty(n))return;e=e[n]}return e}function setPath(e,t,n){if(!e)return;let r,o=0,a=t.length;for(;o<a-1;o++)e=e[r=t[o]]&&"object"==typeof e[r]?e[r]:e[r]={};e[t[o]]=n}function changeListener(e){let t,n,r,o,a=e.currentTarget;for(o=(t=viewsParams.get(a)).length;o--;)n=t[o],(r=ties.get(n.tieName))?setPath(r[PRIVATE_MODEL_SYMBOL],n.path,"INPUT"===a.nodeName&&"checkbox"===a.type?a.checked:a.value):console.warn('no Tie identified by "'+n.tieName+'" found')}function addChangeListenerIfRelevant(e){"INPUT"!==e.nodeName&&"SELECT"!==e.nodeName&&"TEXTAREA"!==e.nodeName||e.addEventListener("change",changeListener)}function delChangeListener(e){e.removeEventListener("change",changeListener)}function add(e){if("IFRAME"===e.nodeName)initDocumentObserver(e.contentDocument),e.addEventListener("load",function(){initDocumentObserver(this.contentDocument),collect(this.contentDocument)}),collect(e.contentDocument);else if(Node.ELEMENT_NODE===e.nodeType)if(e.matches(":defined"))processAddedElement(e);else{let t="";if(e.localName.indexOf("-")>0)t=e.localName;else if(e.getAttribute("is"))t=e.getAttribute("is");else{let n=/.*is\s*=\s*"([^"]+)"\s*.*/.exec(e.outerHTML);n&&n.length>1&&(t=n[1])}t?customElements.whenDefined(t).then(()=>processAddedElement(e)):(console.warn("failed to determine yet undefined custom element name of "+e+" to wait for definition; processing as usual"),processAddedElement(e))}}function processAddedElement(e){let t,n,r,o,a,i,s,l=0;for(s=(t=extractTieParams(e)).length;l<s;l++)n=t[l].tieName,r=t[l].rawPath,(a=(o=views[n]||(views[n]={}))[r]||(o[r]=[])).indexOf(e)<0&&(a.push(e),viewsParams.set(e,t),update(e,(i=ties.get(n))?i[PRIVATE_MODEL_SYMBOL]:null),addChangeListenerIfRelevant(e))}function extractTieParams(e){let t,n=[];return e&&e.dataset&&(t=e.dataset.tie)&&(n=parseTiePropertiesParam(t)),n}function parseTiePropertyParam(e){if(!e||"string"!=typeof e)throw new Error('invalid tie value; found: "'+e+'"; expected (example): "orders:0.address.street > textContent"');let t,n,r=e.split(PARAM_SPLITTER);if(2!==r.length||!r[1])throw new Error('invalid tie value; found: "'+e+'"; expected (example): "orders:0.address.street > textContent"');if(!(t=r[0].split(":")).length||t.length>2||!t[0])throw new Error('invalid tie value; found: "'+e+'"; expected (example): "orders:0.address.street > textContent"');return n=t.length>1?t[1]:"",{tieName:t[0],rawPath:n,path:n.split(".").filter(e=>e),targetProperty:r[1]}}function parseTiePropertiesParam(e){if(!e||"string"!=typeof e)throw new Error('invalid tie value; found: "'+e+'"; expected (example): "orders:0.address.street > textContent, orders:0.address.apt > title"');let t=[],n=e.split(MULTI_PARAMS_SPLITTER),r=0,o=n.length;for(;r<o;r++)try{t.push(parseTiePropertyParam(n[r]))}catch(e){console.error("failed to parse one of a multi param parts",e)}return t}function update(e,t,n,r){let o,a,i,s,l,d=0;for(s=(o=viewsParams.get(e)).length;d<s;d++)a=o[d],n&&0!==a.rawPath.indexOf(n)||(void 0===(i=r&&n===a.rawPath&&void 0!==r.value?r.value:getPath(t,a.path))&&(i=""),"value"===(l=a.targetProperty)&&"INPUT"===e.nodeName&&"checkbox"===e.type?e.checked=i:"href"===l?e.href.baseVal=i:e[a.targetProperty]=i)}function collect(e){if(e&&(e.nodeType===Node.DOCUMENT_NODE||e.nodeType===Node.ELEMENT_NODE)){let t,n;for(t="IFRAME"===e.nodeName?e.contentDocument.getElementsByTagName("*"):e.getElementsByTagName("*"),add(e),n=t.length;n--;)try{add(t[n])}catch(e){console.error("failed to process/add element",e)}}}function discard(e){if(e&&e.getElementsByTagName){let t,n,r,o,a,i,s,l=e.getElementsByTagName("*"),d=0,c=l.length;for(;d<=c;d++)if(t=d<c?l[d]:e,n=viewsParams.get(t)){for(i=0,s=n.length;i<s;i++)r=n[i],views[r.tieName]&&(a=(o=views[r.tieName][r.rawPath]).indexOf(t))>=0&&(o.splice(a,1),delChangeListener(t));viewsParams.delete(t)}}}function move(e,t,n,r){let o,a,i,s,l,d,c;if(n){for(a=0,i=(o=viewsParams.get(e)).length;a<i;a++)s=o[a],views[s.tieName]&&(d=views[s.tieName][s.rawPath])&&(c=d.indexOf(e))>=0&&d.splice(c,1);delChangeListener(e)}if(r){for(o=parseTiePropertiesParam(r),viewsParams.set(e,o),a=0,i=o.length;a<i;a++)s=o[a],(d=(l=views[s.tieName]||(views[s.tieName]={}))[s.rawPath]||(l[s.rawPath]=[])).indexOf(e)<0&&(d.push(e),update(e,ties.get(s.tieName)[PRIVATE_MODEL_SYMBOL],s.rawPath));addChangeListenerIfRelevant(e)}}function processDomChanges(e){let t,n,r,o,a,i,s,l,d=0,c=e.length;for(;d<c;d++)if("attributes"===(r=(n=e[d]).type))"data-tie"===(o=n.attributeName)?move(t=n.target,o,n.oldValue,t.getAttribute(o)):"src"===o&&"IFRAME"===(t=n.target).nodeName&&discard(t.contentDocument);else if("childList"===r){for(i=(a=n.addedNodes).length;i--;)"IFRAME"===(t=a[i]).nodeName?(t.contentDocument&&(initDocumentObserver(t.contentDocument),collect(t.contentDocument)),t.addEventListener("load",function(){initDocumentObserver(this.contentDocument),collect(this.contentDocument)})):t.nodeType!==Node.DOCUMENT_NODE&&t.nodeType!==Node.ELEMENT_NODE||collect(t);for(l=(s=n.removedNodes).length;l--;)"IFRAME"===(t=s[l]).nodeName?discard(t.contentDocument):t.nodeType!==Node.DOCUMENT_NODE&&t.nodeType!==Node.ELEMENT_NODE||discard(t)}}function initDocumentObserver(e){new MutationObserver(processDomChanges).observe(e,{childList:!0,attributes:!0,characterData:!1,subtree:!0,attributeOldValue:!0,characterDataOldValue:!1})}initDocumentObserver(document),collect(document);