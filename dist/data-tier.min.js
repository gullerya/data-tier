import{Observable}from"./object-observer.min.js";export const CHANGE_EVENT_NAME_PROVIDER="changeEventName";export const DEFAULT_TIE_TARGET_PROVIDER="defaultTieTarget";export const ties=new Ties;export const addRootDocument=e=>{if(!e||Node.DOCUMENT_NODE!==e.nodeType&&Node.DOCUMENT_FRAGMENT_NODE!==e.nodeType)throw new Error("not an argument of the valid type (DOCUMENT_NODE, DOCUMENT_FRAGMENT_NODE)");if(roots.has(e))return void console.warn("any root document may be added only once");console.info("DT: scanning the "+e+" for a views...");let t=performance.now(),o=collect(e);console.info("DT: ... scanning the "+e+" for a views DONE (took "+Math.floor(100*(performance.now()-t))/100+"ms, collected "+o+" element/s)"),roots.add(e)};export const removeRootDocument=e=>{roots.has(e)?discard(e):console.warn("no root document "+e+" known")};console.info("DT: starting initialization...");let initStartTime=performance.now();const initParams={},PRIVATE_MODEL_SYMBOL=Symbol("private-tie-model-key"),roots=new WeakSet,views={},viewsParams=new WeakMap,PARAM_SPLITTER=/\s*=>\s*/,MULTI_PARAMS_SPLITTER=/\s*[,;]\s*/;Array.from(new URL(import.meta.url).searchParams).forEach(e=>{initParams[e[0]]=e[1]}),Object.keys(initParams).length?(console.info("DT: init params are as following"),console.dir(initParams)):console.info("DT: no init params found");class Tie{constructor(e){this[PRIVATE_MODEL_SYMBOL]=null,Object.defineProperty(this,"name",{value:e}),Object.seal(this)}get model(){return this[PRIVATE_MODEL_SYMBOL]}set model(e){let t=this[PRIVATE_MODEL_SYMBOL];if(e!==t){let o=ensureObservable(e);o&&o.observe(this.processDataChanges.bind(this)),this[PRIVATE_MODEL_SYMBOL]=o,this.processDataChanges([{path:[]}]),t&&t.revoke()}}processDataChanges(e){let t,o,n,r,a,i,s,l,d,c,f,m=this.name,h=views[m],u=Object.keys(h),E={};if(u.length)for(t=0,o=e.length;t<o;t++){if(r=(n=e[t]).object,a=n.path,!Array.isArray(r)||"insert"!==n.type&&"delete"!==n.type||isNaN(a[a.length-1]))i=a&&a.length?a.join("."):"",f=!1;else{if(E[i=a.slice(0,-1).join(".")]===r)continue;E[i]=r,f=!0}for(s=u.length;s;)if(0===(l=u[--s]).indexOf(i))for(c=(d=h[l]).length;c;)update(d[--c],i,f?null:n)}}}function Ties(){const e={},t=/^[a-zA-Z0-9]+$/;function o(e){if(!e||"string"!=typeof e)throw new Error("tie name MUST be a non empty string");if(!t.test(e))throw new Error("tie name MUST contain alphanumeric characters ONLY (use "+t+' to check yourself); "'+e+'" not fits');return!0}this.get=function(t){return o(t),e[t]},this.create=function(t,n){if(e[t])throw new Error("tie ("+t+") is already present and MAY NOT be re-created");o(t),ensureObservable(n);let r=new Tie(t);return e[t]=r,views.hasOwnProperty(t)||(views[t]={}),r.model=n,r},this.remove=function(t){let n;if("object"==typeof t&&t.name)n=t.name;else{if("string"!=typeof t||!o(t))throw new Error("tie to remove MUST either be a valid tie name or tie self");n=t}delete views[n];let r=e[n];r&&(r[PRIVATE_MODEL_SYMBOL]&&r[PRIVATE_MODEL_SYMBOL].revoke(),delete e[n])},Object.freeze(this)}function ensureObservable(e){if(void 0===e||null===e)return e;if("object"!=typeof e)throw new Error(e+" is not an object");if(Observable.isObservable(e))return e;if(Observable){if(e.observe||e.unobserve||e.revoke)throw new Error(e+" is not of type Observable and can not be transformed into Observable (some of the properties already occupied?)");return Observable.from(e)}throw new Error(e+" is not of type Observable and no embedded Observable implementation found")}function getPath(e,t){if(!e)return null;let o,n=0,r=t.length;for(;n<r;n++){if(o=t[n],!e||!e.hasOwnProperty(o))return null;e=e[o]}return e}function setPath(e,t,o){if(!e)return;let n,r=0,a=t.length;for(;r<a-1;r++)e[n=t[r]]&&"object"==typeof e[n]?e=e[n]:(e={})[n]=e;e[t[r]]=o}function changeListener(e){let t,o,n,r,a,i=e.currentTarget;for(r=(t=viewsParams.get(i)).length;r;)o=t[--r],(n=ties.get(o.tieName))?(a="INPUT"===i.nodeName&&"checkbox"===i.type?i.checked:i[getDefaultTargetProperty(i)],setPath(n[PRIVATE_MODEL_SYMBOL],o.path,a)):console.warn('no Tie identified by "'+o.tieName+'" found')}function addChangeListenerIfRelevant(e){let t=obtainChangeEventName(e);t&&e.addEventListener(t,changeListener)}function delChangeListener(e){let t=obtainChangeEventName(e);t&&e.removeEventListener(t,changeListener)}function obtainChangeEventName(e){let t=e[CHANGE_EVENT_NAME_PROVIDER];return t||"INPUT"!==e.nodeName&&"SELECT"!==e.nodeName&&"TEXTAREA"!==e.nodeName||(t="change"),t}function add(e){if(e.matches(":defined"))processAddedElement(e);else{let t="";if(e.localName.indexOf("-")>0)t=e.localName;else{let o=/.*is\s*=\s*"([^"]+)"\s*.*/.exec(e.outerHTML);o&&o.length>1&&(t=o[1])}t?customElements.whenDefined(t).then(()=>processAddedElement(e)):(console.warn("failed to determine yet undefined custom element name of "+e+" to wait for definition; processing as usual"),processAddedElement(e))}}function processAddedElement(e){let t,o,n,r,a,i,s=0;for(i=(t=extractTieParams(e)).length;s<i;s++)o=t[s].tieName,n=t[s].rawPath,(a=(r=views[o]||(views[o]={}))[n]||(r[n]=[])).indexOf(e)<0&&(a.push(e),viewsParams.set(e,t),update(e),addChangeListenerIfRelevant(e))}function extractTieParams(e){let t,o=[];return e&&e.dataset&&(t=e.dataset.tie)&&(o=parseTiePropertiesParam(t,e)),o}function parseTiePropertyParam(e,t){let o,n,r=e.split(PARAM_SPLITTER);if(1===r.length&&r.push(getDefaultTargetProperty(t)),!(o=r[0].split(":")).length||o.length>2||!o[0])throw new Error('invalid tie value; found: "'+e+'"; expected (example): "orders:0.address.street => textContent"');return n=o.length>1?o[1]:"",{tieName:o[0],rawPath:n,path:n.split(".").filter(e=>e),targetProperty:r[1]}}function parseTiePropertiesParam(e,t){if(!e||"string"!=typeof e)throw new Error('invalid tie value; found: "'+e+'"; expected (example): "orders:0.address.street => textContent, orders:0.address.apt => title"');let o=[],n=e.split(MULTI_PARAMS_SPLITTER),r=0,a=n.length;for(;r<a;r++)if(n[r])try{o.push(parseTiePropertyParam(n[r],t))}catch(e){console.error("failed to parse one of a multi param parts",e)}return o}function getDefaultTargetProperty(e){let t=e[DEFAULT_TIE_TARGET_PROVIDER];if(!t){let o=e.nodeName;t="INPUT"===o||"SELECT"===o||"TEXTAREA"===o?"value":"IMG"===o||"IFRAME"===o||"SOURCE"===o?"src":"textContent"}return t}function update(e,t,o){let n,r,a,i,s,l,d,c=0;for(l=(n=viewsParams.get(e)).length;c<l;c++)r=n[c],t&&0!==r.rawPath.indexOf(t)||(a=ties.get(r.tieName))&&(i=a.model,void 0===(s=o&&t===r.rawPath&&void 0!==o.value?o.value:getPath(i,r.path))&&(s=""),"value"===(d=r.targetProperty)&&"INPUT"===e.nodeName&&"checkbox"===e.type?e.checked=s:"href"===d?e.href.baseVal=s:e[d]=s)}function collect(e){let t=e.querySelectorAll("*[data-tie]"),o=t.length,n=t.length;for(Node.ELEMENT_NODE===e.nodeType&&(add(e),n++);o;)try{add(t[--o])}catch(e){console.error("failed to process/add element",e)}if(e.shadowRoot&&addRootDocument(e.shadowRoot),e.getElementsByTagName){let t,o=e.getElementsByTagName("*");for(let e=0,n=o.length;e<n;e++)(t=o[e].shadowRoot)&&addRootDocument(t)}return n}function discard(e){if(e.querySelectorAll){let t,o,n,r,a,i,s,l=e.querySelectorAll("*[data-tie]"),d=0,c=l.length;for(;d<=c;d++)if(t=d<c?l[d]:e,o=viewsParams.get(t)){for(i=0,s=o.length;i<s;i++)n=o[i],views[n.tieName]&&(a=(r=views[n.tieName][n.rawPath]).indexOf(t))>=0&&(r.splice(a,1),delChangeListener(t));viewsParams.delete(t)}}if(e.shadowRoot&&removeRootDocument(e.shadowRoot),e.getElementsByTagName){let t,o=e.getElementsByTagName("*");for(let e=0,n=o.length;e<n;e++)(t=o[e].shadowRoot)&&removeRootDocument(t)}}function move(e,t,o,n){let r,a,i,s,l,d,c;if(o){for(a=0,i=(r=viewsParams.get(e)).length;a<i;a++)s=r[a],views[s.tieName]&&(d=views[s.tieName][s.rawPath])&&(c=d.indexOf(e))>=0&&d.splice(c,1);delChangeListener(e)}if(n){for(r=parseTiePropertiesParam(n,e),viewsParams.set(e,r),a=0,i=r.length;a<i;a++)s=r[a],(d=(l=views[s.tieName]||(views[s.tieName]={}))[s.rawPath]||(l[s.rawPath]=[])).indexOf(e)<0&&(d.push(e),update(e,s.rawPath));addChangeListenerIfRelevant(e)}}function processDomChanges(e){let t,o,n,r,a,i,s,l,d,c=0,f=e.length;for(;c<f;c++)if("attributes"===(r=(n=e[c]).type))"data-tie"===(a=n.attributeName)&&move(t=n.target,a,n.oldValue,t.getAttribute(a));else if("childList"===r){for(s=(i=n.addedNodes).length;s;)o=(t=i[--s]).nodeType,Node.ELEMENT_NODE===o&&collect(t);for(d=(l=n.removedNodes).length;d;)o=(t=l[--d]).nodeType,Node.ELEMENT_NODE===o&&discard(t)}}function initDocumentObserver(e){new MutationObserver(processDomChanges).observe(e,{childList:!0,subtree:!0,attributes:!0,attributeOldValue:!0,attributeFilter:["data-tie"],characterData:!1,characterDataOldValue:!1})}console.info("DT: initializing DOM observer on "+document),initDocumentObserver(document),addRootDocument(document),console.info("DT: ... initialization DONE (took "+Math.floor(100*(performance.now()-initStartTime))/100+"ms)");