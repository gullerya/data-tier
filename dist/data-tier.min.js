import{Observable}from"./object-observer.min.js";export const ties=new Ties;export const CHANGE_EVENT_NAME_PROVIDER="changeEventName";export const DEFAULT_TIE_TARGET_PROVIDER="defaultTieTarget";console.info("DT: starting initialization...");let initStartTime=performance.now();const initParams={},PRIVATE_MODEL_SYMBOL=Symbol("private-tie-model-key"),views={},viewsParams=new WeakMap,PARAM_SPLITTER=/\s*=>\s*/,MULTI_PARAMS_SPLITTER=/\s*[,;]\s*/;Array.from(new URL(import.meta.url).searchParams).forEach(e=>{initParams[e[0]]=e[1]}),Object.keys(initParams).length?(console.info("DT: init params are as following"),console.dir(initParams)):console.info("DT: no init params found");class Tie{constructor(e){this[PRIVATE_MODEL_SYMBOL]=null,Object.defineProperty(this,"name",{value:e}),Object.seal(this)}get model(){return this[PRIVATE_MODEL_SYMBOL]}set model(e){let t=this[PRIVATE_MODEL_SYMBOL];if(e!==t){let n=ensureObservable(e);n&&n.observe(this.processDataChanges.bind(this)),this[PRIVATE_MODEL_SYMBOL]=n,this.processDataChanges([{path:[]}]),t&&t.revoke()}}processDataChanges(e){let t,n,r,a,i,o,s,l,c,d,f=this.name,m=views[f],h=Object.keys(m),u={};if(h.length)for(t=0,n=e.length;t<n;t++){if(a=(r=e[t]).path,!Array.isArray(r.object)||"insert"!==r.type&&"delete"!==r.type||isNaN(a[a.length-1]))i=a&&a.length?a.join("."):"",d=!1;else{if(u[i=a.slice(0,-1).join(".")]===r.object)continue;u[i]=r.object,d=!0}for(o=h.length;o--;)if(0===(s=h[o]).indexOf(i))for(c=(l=m[s]).length;c--;)update(l[c],i,d?null:r)}}}function Ties(){const e={},t=/^[a-zA-Z0-9]+$/;function n(e){if(!e||"string"!=typeof e)throw new Error("tie name MUST be a non empty string");if(!t.test(e))throw new Error("tie name MUST contain alphanumeric characters ONLY (use "+t+' to check yourself); "'+e+'" not fits');return!0}this.get=function(t){return n(t),e[t]},this.create=function(t,r){if(e[t])throw new Error("tie ("+t+") is already present and MAY NOT be re-created");n(t),ensureObservable(r);let a=new Tie(t);return e[t]=a,views.hasOwnProperty(t)||(views[t]={}),a.model=r,a},this.remove=function(t){let r;if("object"==typeof t&&t.name)r=t.name;else{if("string"!=typeof t||!n(t))throw new Error("tie to remove MUST either be a valid tie name or tie self");r=t}delete views[r];let a=e[r];a&&(a[PRIVATE_MODEL_SYMBOL]&&a[PRIVATE_MODEL_SYMBOL].revoke(),delete e[r])},Object.freeze(this)}function ensureObservable(e){if(void 0===e||null===e)return e;if("object"!=typeof e)throw new Error(e+" is not an object");if(Observable.isObservable(e))return e;if(Observable){if(e.observe||e.unobserve||e.revoke)throw new Error(e+" is not of type Observable and can not be transformed into Observable (some of the properties already occupied?)");return Observable.from(e)}throw new Error(e+" is not of type Observable and no embedded Observable implementation found")}function getPath(e,t){if(!e)return;let n,r=0,a=t.length;for(;r<a;r++){if(n=t[r],!e||!e.hasOwnProperty(n))return;e=e[n]}return e}function setPath(e,t,n){if(!e)return;let r,a=0,i=t.length;for(;a<i-1;a++)e=e[r=t[a]]&&"object"==typeof e[r]?e[r]:e[r]={};e[t[a]]=n}function changeListener(e){let t,n,r,a,i,o=e.currentTarget;for(a=(t=viewsParams.get(o)).length;a--;)n=t[a],(r=ties.get(n.tieName))?(i="INPUT"===o.nodeName&&"checkbox"===o.type?o.checked:o[getDefaultTargetProperty(o)],setPath(r[PRIVATE_MODEL_SYMBOL],n.path,i)):console.warn('no Tie identified by "'+n.tieName+'" found')}function addChangeListenerIfRelevant(e){let t=obtainChangeEventName(e);t&&e.addEventListener(t,changeListener)}function delChangeListener(e){let t=obtainChangeEventName(e);t&&e.removeEventListener(t,changeListener)}function obtainChangeEventName(e){let t=e[CHANGE_EVENT_NAME_PROVIDER];return t||"INPUT"!==e.nodeName&&"SELECT"!==e.nodeName&&"TEXTAREA"!==e.nodeName||(t="change"),t}function add(e){if(Node.ELEMENT_NODE===e.nodeType)if(e.matches(":defined"))processAddedElement(e);else{let t="";if(e.localName.indexOf("-")>0)t=e.localName;else if(t=e.getAttribute("is"));else{let n=/.*is\s*=\s*"([^"]+)"\s*.*/.exec(e.outerHTML);n&&n.length>1&&(t=n[1])}t?customElements.whenDefined(t).then(()=>processAddedElement(e)):(console.warn("failed to determine yet undefined custom element name of "+e+" to wait for definition; processing as usual"),processAddedElement(e))}}function processAddedElement(e){let t,n,r,a,i,o,s=0;for(o=(t=extractTieParams(e)).length;s<o;s++)n=t[s].tieName,r=t[s].rawPath,(i=(a=views[n]||(views[n]={}))[r]||(a[r]=[])).indexOf(e)<0&&(i.push(e),viewsParams.set(e,t),update(e),addChangeListenerIfRelevant(e))}function extractTieParams(e){let t,n=[];return e&&e.dataset&&(t=e.dataset.tie)&&(n=parseTiePropertiesParam(t,e)),n}function parseTiePropertyParam(e,t){let n,r,a=e.split(PARAM_SPLITTER);if(1===a.length&&a.push(getDefaultTargetProperty(t)),!(n=a[0].split(":")).length||n.length>2||!n[0])throw new Error('invalid tie value; found: "'+e+'"; expected (example): "orders:0.address.street => textContent"');return r=n.length>1?n[1]:"",{tieName:n[0],rawPath:r,path:r.split(".").filter(e=>e),targetProperty:a[1]}}function parseTiePropertiesParam(e,t){if(!e||"string"!=typeof e)throw new Error('invalid tie value; found: "'+e+'"; expected (example): "orders:0.address.street => textContent, orders:0.address.apt => title"');let n=[],r=e.split(MULTI_PARAMS_SPLITTER),a=0,i=r.length;for(;a<i;a++)if(r[a])try{n.push(parseTiePropertyParam(r[a],t))}catch(e){console.error("failed to parse one of a multi param parts",e)}return n}function getDefaultTargetProperty(e){let t=e[DEFAULT_TIE_TARGET_PROVIDER];if(!t){let n=e.nodeName;t="INPUT"===n||"SELECT"===n||"TEXTAREA"===n?"value":"textContent"}return t}function update(e,t,n){let r,a,i,o,s,l,c,d=0;for(l=(r=viewsParams.get(e)).length;d<l;d++)a=r[d],t&&0!==a.rawPath.indexOf(t)||(i=ties.get(a.tieName))&&(o=i.model,void 0===(s=n&&t===a.rawPath&&void 0!==n.value?n.value:getPath(o,a.path))&&(s=""),"value"===(c=a.targetProperty)&&"INPUT"===e.nodeName&&"checkbox"===e.type?e.checked=s:"href"===c?e.href.baseVal=s:e[c]=s)}function collect(e){let t=e.getElementsByTagName("*"),n=t.length;for(add(e);n--;)try{add(t[n])}catch(e){console.error("failed to process/add element",e)}}function discard(e){if(e&&e.getElementsByTagName){let t,n,r,a,i,o,s,l=e.getElementsByTagName("*"),c=0,d=l.length;for(;c<=d;c++)if(t=c<d?l[c]:e,n=viewsParams.get(t)){for(o=0,s=n.length;o<s;o++)r=n[o],views[r.tieName]&&(i=(a=views[r.tieName][r.rawPath]).indexOf(t))>=0&&(a.splice(i,1),delChangeListener(t));viewsParams.delete(t)}}}function move(e,t,n,r){let a,i,o,s,l,c,d;if(n){for(i=0,o=(a=viewsParams.get(e)).length;i<o;i++)s=a[i],views[s.tieName]&&(c=views[s.tieName][s.rawPath])&&(d=c.indexOf(e))>=0&&c.splice(d,1);delChangeListener(e)}if(r){for(a=parseTiePropertiesParam(r,e),viewsParams.set(e,a),i=0,o=a.length;i<o;i++)s=a[i],(c=(l=views[s.tieName]||(views[s.tieName]={}))[s.rawPath]||(l[s.rawPath]=[])).indexOf(e)<0&&(c.push(e),update(e,s.rawPath));addChangeListenerIfRelevant(e)}}function processDomChanges(e){let t,n,r,a,i,o,s,l,c=0,d=e.length;for(;c<d;c++)if("attributes"===(r=(n=e[c]).type))"data-tie"===(a=n.attributeName)&&move(t=n.target,a,n.oldValue,t.getAttribute(a));else if("childList"===r){for(o=(i=n.addedNodes).length;o--;)(t=i[o]).nodeType!==Node.DOCUMENT_NODE&&t.nodeType!==Node.ELEMENT_NODE||collect(t);for(l=(s=n.removedNodes).length;l--;)(t=s[l]).nodeType!==Node.DOCUMENT_NODE&&t.nodeType!==Node.ELEMENT_NODE||discard(t)}}function initDocumentObserver(e){new MutationObserver(processDomChanges).observe(e,{childList:!0,attributes:!0,characterData:!1,subtree:!0,attributeOldValue:!0,characterDataOldValue:!1})}console.info("DT: initializing DOM observer on "+document),initDocumentObserver(document),console.info("DT: scanning the "+document+" for a views...");let baseDocumentScanStartTime=performance.now();collect(document),console.info("DT: ... scanning the "+document+" for a views DONE (took "+Math.floor(100*(performance.now()-baseDocumentScanStartTime))/100+"ms)"),console.info("DT: ... initialization DONE (took "+Math.floor(100*(performance.now()-initStartTime))/100+"ms)");