import{Ties}from"./ties.min.js";import{DEFAULT_TIE_TARGET_PROVIDER,getTargetProperty,extractViewParams,CHANGE_EVENT_NAME_PROVIDER,addChangeListener,delChangeListener,getPath,setPath,setViewProperty,callViewFunction}from"./utils.min.js";export{DEFAULT_TIE_TARGET_PROVIDER,CHANGE_EVENT_NAME_PROVIDER};export const params=Object.freeze(Array.from(new URL(import.meta.url).searchParams).reduce((e,t)=>(e[t[0]]=t[1],e),{}));export const addRootDocument=e=>{if(!e||Node.DOCUMENT_NODE!==e.nodeType&&Node.DOCUMENT_FRAGMENT_NODE!==e.nodeType)throw new Error("invalid argument, NULL or not one of: DOCUMENT_NODE, DOCUMENT_FRAGMENT_NODE");return roots.has(e)?(console.warn("any root document may be added only once"),!1):(new MutationObserver(processDomChanges).observe(e,MUTATION_OBSERVER_OPTIONS),addTree(e),roots.add(e),!0)};export const removeRootDocument=e=>roots.has(e)?(dropTree(e),roots.delete(e),!0):(console.warn("no root document "+e+" known"),!1);console.info("DT: starting initialization...");const initStartTime=performance.now(),MUTATION_OBSERVER_OPTIONS={childList:!0,subtree:!0,attributes:!0,attributeOldValue:!0,attributeFilter:["data-tie"],characterData:!1,characterDataOldValue:!1},ELEMENT_PROCESSED_SYMBOL=Symbol("element-processed"),VIEW_PARAMS_KEY=Symbol("view.params.key"),roots=new WeakSet,views={},scopedViews=new WeakMap;export const ties=new Ties(VIEW_PARAMS_KEY,views);function changeListener(e){const t=e.currentTarget,o=getTargetProperty(t),n=t[VIEW_PARAMS_KEY];let a,r,i,s=n.length;for(;s;)(a=n[--s]).targetProperty===o&&(r=ties.get(a.tieKey))&&(i=t[o],setPath(r,a.path,i))}function add(e){if(e[ELEMENT_PROCESSED_SYMBOL]=!0,e.matches(":defined")){const t=extractViewParams(e);let o;if(t&&(o=t.length)){for(e[VIEW_PARAMS_KEY]=t;o;){const n=t[--o];if(n.isFunctional)n.fParams.forEach(t=>{const o=t.tieKey,n=t.rawPath,a=views[o]||(views[o]={}),r=a[n]||(a[n]=[]);r.indexOf(e)<0&&r.push(e)});else{const t=n.tieKey,o=n.rawPath;let a;if(n.scoped){const t=e.getRootNode().host;scopedViews.has(t)?a=scopedViews.get(t):(a={},scopedViews.set(t,a))}else a=views[t]||(views[t]={});const r=a[o]||(a[o]=[]);r.indexOf(e)<0&&r.push(e)}}updateFromView(e),addChangeListener(e,changeListener)}e.hasAttribute("data-tie-root")&&ties.create(e),e.shadowRoot&&!e.hasAttribute("data-tie-blackbox")&&addRootDocument(e.shadowRoot)}else waitUndefined(e)}function waitUndefined(e){let t="";if(e.localName.indexOf("-")>0)t=e.localName;else{const o=/.*is\s*=\s*"([^"]+)"\s*.*/.exec(e.outerHTML);o&&o.length>1&&(t=o[1])}t?customElements.whenDefined(t).then(()=>add(e)):console.warn("failed to determine tag of yet undefined custom element "+e+", abandoning")}function updateFromView(e,t){const o=e[VIEW_PARAMS_KEY];let n=o.length;for(;n;){const a=o[--n];if(a.isFunctional){if(!t||a.fParams.some(e=>0===e.rawPath.indexOf(t))){let t=!1;const o=[];a.fParams.forEach(e=>{let n;const a=ties.get(e.tieKey);a&&(n=getPath(a,e.path),t=!0),o.push(n)}),t&&(o.push(null),callViewFunction(e,a.targetProperty,o))}}else if(!t||0===a.rawPath.indexOf(t)){const t=ties.get(a.tieKey);if(void 0===t)continue;let o=getPath(t,a.path);void 0===o&&(o=""),setViewProperty(e,a,o)}}}function addTree(e){let t=[e];e.childElementCount&&(t=Array.from(e.querySelectorAll("*"))).unshift(e);let o=t.length;for(;o;)try{const e=t[--o];Node.ELEMENT_NODE!==e.nodeType||e[ELEMENT_PROCESSED_SYMBOL]||add(e)}catch(e){console.error("failed to process/add element",e)}}function dropTree(e){let t;e.childElementCount?(t=Array.from(e.querySelectorAll("*"))).unshift(e):t=[e];let o=t.length;for(;o;){const e=t[--o],n=e[VIEW_PARAMS_KEY];if(n){let t=n.length;for(;t;){const o=n[--t];if(!views[o.tieKey])continue;const a=views[o.tieKey][o.rawPath],r=a.indexOf(e);r>=0&&(a.splice(r,1),delChangeListener(e,changeListener))}delete e[VIEW_PARAMS_KEY]}e.shadowRoot&&removeRootDocument(e.shadowRoot)}}function move(e,t,o){let n,a,r;if(t&&(n=e[VIEW_PARAMS_KEY])){for(a=n.length;a;){const t=n[--a];if(!views[t.tieKey])continue;const o=views[t.tieKey][t.rawPath];o&&(r=o.indexOf(e))>=0&&o.splice(r,1)}delChangeListener(e,changeListener)}if(o&&(n=extractViewParams(e))&&(a=n.length)){for(e[VIEW_PARAMS_KEY]=n;a;){const t=n[--a],o=views[t.tieKey]||(views[t.tieKey]={}),r=o[t.rawPath]||(o[t.rawPath]=[]);r.indexOf(e)<0&&(r.push(e),updateFromView(e,t.rawPath))}addChangeListener(e,changeListener)}}function processDomChanges(e){const t=e.length;let o,n,a,r,i,s,d,c,l=0;for(;l<t;l++)if("attributes"===(r=(a=e[l]).type)){const e=a.attributeName,t=a.target,o=a.oldValue,n=t.getAttribute(e);o!==n&&move(t,o,n)}else if("childList"===r){for(s=(i=a.addedNodes).length;s;)n=(o=i[--s]).nodeType,Node.ELEMENT_NODE===n&&addTree(o);for(c=(d=a.removedNodes).length;c;)n=(o=d[--c]).nodeType,Node.ELEMENT_NODE===n&&dropTree(o)}}"false"!==params.autostart&&!1!==params.autostart&&addRootDocument(document),console.info("DT: ... initialization DONE (took "+Math.floor(100*(performance.now()-initStartTime))/100+"ms)");