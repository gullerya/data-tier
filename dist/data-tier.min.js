import{Ties}from"./ties.min.js";import{VIEW_PARAMS_KEY,DEFAULT_TIE_TARGET_PROVIDER,getTargetProperty,extractViewParams,CHANGE_EVENT_NAME_PROVIDER,addChangeListener,delChangeListener,getPath,setPath,setViewProperty,callViewFunction}from"./utils.min.js";import{addView,delView}from"./views.min.js";export{DEFAULT_TIE_TARGET_PROVIDER,CHANGE_EVENT_NAME_PROVIDER};export const params=Object.freeze(Array.from(new URL(import.meta.url).searchParams).reduce((e,t)=>(e[t[0]]=t[1],e),{}));export const addRootDocument=e=>{if(!e||Node.DOCUMENT_NODE!==e.nodeType&&Node.DOCUMENT_FRAGMENT_NODE!==e.nodeType)throw new Error("invalid argument, NULL or not one of: DOCUMENT_NODE, DOCUMENT_FRAGMENT_NODE");return roots.has(e)?(console.warn("any root document may be added only once"),!1):(new MutationObserver(processDomChanges).observe(e,MUTATION_OBSERVER_OPTIONS),addTree(e),roots.add(e),!0)};export const removeRootDocument=e=>roots.has(e)?(dropTree(e),roots.delete(e),!0):(console.warn("no root document "+e+" known"),!1);console.info("DT: starting initialization...");const initStartTime=performance.now(),MUTATION_OBSERVER_OPTIONS={childList:!0,subtree:!0,attributes:!0,attributeOldValue:!0,attributeFilter:["data-tie"],characterData:!1,characterDataOldValue:!1},roots=new WeakSet;export const ties=new Ties;function changeListener(e){const t=e.currentTarget,o=getTargetProperty(t),n=t[VIEW_PARAMS_KEY];let a,r,i,s=n.length;for(;s;)(a=n[--s]).targetProperty===o&&(r=ties.get(a.tieKey))&&(i=t[o],setPath(r,a.path,i))}function add(e){if(e.matches(":defined")){const t=extractViewParams(e);t&&(addView(e,t),updateFromView(e),addChangeListener(e,changeListener)),e.shadowRoot&&!e.hasAttribute("data-tie-blackbox")&&addRootDocument(e.shadowRoot)}else waitUndefined(e)}function waitUndefined(e){let t="";if(e.localName.indexOf("-")>0)t=e.localName;else{const o=/.*is\s*=\s*"([^"]+)"\s*.*/.exec(e.outerHTML);o&&o.length>1&&(t=o[1])}t?customElements.whenDefined(t).then(()=>add(e)):console.warn("failed to determine tag of yet undefined custom element "+e+", abandoning")}function updateFromView(e){const t=e[VIEW_PARAMS_KEY];let o=t.length;for(;o;){const n=t[--o];if(n.isFunctional){let t=!1;const o=[];n.fParams.forEach(e=>{let n;const a=ties.get(e.tieKey);a&&(n=getPath(a,e.path),t=!0),o.push(n)}),t&&(o.push(null),callViewFunction(e,n.targetProperty,o))}else{const t=ties.get(n.tieKey);if(void 0===t)continue;let o=getPath(t,n.path);void 0===o&&(o=""),setViewProperty(e,n,o)}}}function addTree(e){let t,o=[e];e.childElementCount&&(o=Array.from(e.querySelectorAll("*"))).unshift(e);let n=o.length;for(;n;)try{t=o[--n],Node.ELEMENT_NODE!==t.nodeType||t[VIEW_PARAMS_KEY]||add(t)}catch(e){console.error("failed to process/add element",e)}}function dropTree(e){let t,o,n,a=[e];for(e.childElementCount&&(a=Array.from(e.querySelectorAll("*"))).unshift(e),t=a.length;t;)(n=(o=a[--t])[VIEW_PARAMS_KEY])&&(delView(o,n),delChangeListener(o,changeListener)),o.shadowRoot&&removeRootDocument(o.shadowRoot)}function onTieParamChange(e,t,o){let n;t&&(n=e[VIEW_PARAMS_KEY])&&(delView(e,n),delChangeListener(e,changeListener)),o&&(n=extractViewParams(e))&&(addView(e,n),updateFromView(e),addChangeListener(e,changeListener))}function processDomChanges(e){const t=e.length;let o,n,a,r,i,s,d,c,l=0;for(;l<t;l++)if("attributes"===(r=(a=e[l]).type)){const e=a.attributeName,t=a.target,o=a.oldValue,n=t.getAttribute(e);o!==n&&onTieParamChange(t,o,n)}else if("childList"===r){for(s=(i=a.addedNodes).length;s;)n=(o=i[--s]).nodeType,Node.ELEMENT_NODE===n&&addTree(o);for(c=(d=a.removedNodes).length;c;)n=(o=d[--c]).nodeType,Node.ELEMENT_NODE===n&&dropTree(o)}}"false"!==params.autostart&&!1!==params.autostart&&addRootDocument(document),console.info("DT: ... initialization DONE (took "+Math.floor(100*(performance.now()-initStartTime))/100+"ms)");